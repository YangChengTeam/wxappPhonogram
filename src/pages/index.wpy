<style lang="less">
.main-bg {
   position: fixed;
   width: 100%;
   height: 100%;
   background-color: #72d9fa;
   background-size: 100% 100%;
   background-attachment: fixed;
}

.menu {
    display: flex;
    flex-direction: row;
    height: 10%;
    width: 100%;
    align-items: center;
}


.menu-learn {
   background-color: #fff;
   background: url('http://tic.upkao.com/Public/wxappImgs/learn-yb.png') no-repeat;
   background-size: 100% 100%;
   width: 198rpx;
   height: 105rpx;
}

.menu-learn-hover {
   background: url('http://tic.upkao.com/Public/wxappImgs/learn-yb-hover.png') no-repeat;
   background-size: 100% 100%;
}

.menu-read2me {
   background-color: #fff;
   background: url('http://tic.upkao.com/Public/wxappImgs/read2me.png') no-repeat;
   background-size: 100% 100%;
   width: 198rpx;
   height: 105rpx;
}

.menu-read2me-hover {
   background: url('http://tic.upkao.com/Public/wxappImgs/read2me-hover.png') no-repeat;
   background-size: 100% 100%;
}

.menu-interest {
   background-color: #fff;
   background: url('http://tic.upkao.com/Public/wxappImgs/interest.png') no-repeat;
   background-size: 100% 100%;
   width: 274rpx;
   height: 105rpx;
}

.menu-interest-hover {
   background: url('http://tic.upkao.com/Public/wxappImgs/interest-hover.png') no-repeat;
   background-size: 100% 100%;
}

swiper {
   width:100%;
   height:90%;
}

.ad {
   position: absolute;
   width:223rpx;
   height:140rpx;
   right:20rpx;
   bottom: 120rpx;
}

.pay-ppw {
   position: fixed;
   width: 100%;
   height: 100%;
   background: rgba(0,0,0,0.5);
   display: flex;
   flex-direction: column;
   justify-content: flex-start;
   align-items: center;
   top:0;
   left:0;
}

.intro {
   position: fixed;
   width: 100%;
   height: 100%;
   background: rgba(0,0,0,0.5);
   display: flex;
   flex-direction: column;
   justify-content: flex-start;
   align-items: center;
   top:0;
   left:0;
}

.intro image {
   width: 562rpx;
   height: 812rpx;
   margin-top: 100rpx;
}

.intro-close {
    width: 97rpx;
    height: 97rpx;
    background: url('http://tic.upkao.com/Public/wxappImgs/pay-close.png') no-repeat;
    background-size: 100% 100%;
    margin-top:50rpx;
}

.share-confirm {
    background: url('http://tic.upkao.com/Public/wxappImgs/share-btn.png') no-repeat;
    background-size: 100% 100%;
    width: 618rpx;
    height: 108rpx;
    margin-top: 35rpx;
}

.g2y-confirm {
    background: url('http://tic.upkao.com/Public/wxappImgs/go2yb.png') no-repeat;
    background-size: 100% 100%;
    width: 618rpx;
    height: 108rpx;
    margin-top: 35rpx;
}

.pay-ppw-bg {
    width: 702rpx;
    height: 879rpx;
    background: url('http://tic.upkao.com/Public/wxappImgs/pay-ppw-bg.png') no-repeat;
    background-size: 100% 100%;
    margin-top:50rpx;
}

.pay-content {
    display: block;
    height: 528rpx;
    width: 622rpx;
    margin-top: 160rpx;
    margin-left:40rpx;
    overflow-y: auto; 
}

.pay-item {
    display: flex;
    flex-direction: row;
    height: 112rpx;
    width: 100%;
    align-items: center;
    justify-content: space-around;
    margin-bottom: 20rpx;
}



.pay-info {
    display: flex;
    flex-direction: row;
    justify-content: space-around;
    align-items: center;
    background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAigAAABwCAYAAAA0T4s2AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTM4IDc5LjE1OTgyNCwgMjAxNi8wOS8xNC0wMTowOTowMSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTcgKFdpbmRvd3MpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjRBNkI3Qjg4MUFCODExRTg4MThCQzhFOEM4MDgxNTEyIiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjRBNkI3Qjg5MUFCODExRTg4MThCQzhFOEM4MDgxNTEyIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NEE2QjdCODYxQUI4MTFFODgxOEJDOEU4QzgwODE1MTIiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NEE2QjdCODcxQUI4MTFFODgxOEJDOEU4QzgwODE1MTIiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5Cy3oDAAAHaElEQVR42uzd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') no-repeat;
    background-size: 100% 100%;
    width: 552rpx;
    height: 112rpx;
    font-size: 18.14rpx;
    color: #999;
}

.pay-desc {
    width: 57%;
}

.pay-select {
    width: 50rpx;
    height: 50rpx;

}

.pay-close {
    width: 97rpx;
    height: 97rpx;
    background: url('http://tic.upkao.com/Public/wxappImgs/pay-close.png') no-repeat;
    background-size: 100% 100%;
    margin-top:50rpx;
}

.pay-confirm-wrap {
    justify-content: flex-end;
    flex-grow: 1;
    display:flex;
    flex-direction: column;
}

.pay-confirm {
    width: 618rpx;
    height: 108rpx;
    background: url('http://tic.upkao.com/Public/wxappImgs/pay-confirm.png') no-repeat;
    background-size: 100% 100%;
    margin-bottom: 40rpx;
}

.pay-confirm:hover {
    background: url('http://tic.upkao.com/Public/wxappImgs/pay-confirm-hover.png') no-repeat;
    background-size: 100% 100%;
}

.pay-num {
    width: 64rpx;
    height: 65rpx;
    margin-left:10rpx;
}

.contact-ppw-bg {
    display: flex;
    align-items: center;
    width: 702rpx;
    height: 702rpx;
    background: url('http://tic.upkao.com/Public/wxappImgs/contact_bg.png') no-repeat;
    background-size: 100% 100%;
    margin-top: 100rpx;
    flex-direction: column;
}

.contact-close {
    width: 97rpx;
    height: 97rpx;
    background: url('http://tic.upkao.com/Public/wxappImgs/pay-close.png') no-repeat;
    background-size: 100% 100%;
    margin-top:50rpx;
}

.contact-input-bg {
    display:flex;
    width: 600rpx;
    height: 112rpx;
    background: url('http://tic.upkao.com/Public/wxappImgs/contact_input.png') no-repeat;
    background-size: 100% 100%;
    align-items: center;
    margin-top:20rpx;
}

.contact-input-bg  input {
   margin-left:15rpx;
}

.contact-confirm {
    background: url('http://tic.upkao.com/Public/wxappImgs/contact_confirm.png') no-repeat;
    background-size: 100% 100%;
    width: 618rpx;
    height: 108rpx;
    margin-top: 35rpx;
}

.pay-title {
  color: #b05739;
  font-size: 30rpx;
  overflow-x: hidden;
  height: 40rpx;
}

.pay-price {
   margin-right: 10rpx;
}

.pay-new-price {
   color: #fe5655;
   font-size: 36rpx;
   text-align: right;
}

.pay-old-price {
   font-size: 18rpx;
   text-align: right;
}

.key-video {
    width: 578rpx;
    height: 316rpx;
    left: 75rpx;
    top: 220rpx;
    position: absolute;
}

.video {
  width: 602rpx;
  height: 340rpx;
  flex-direction: row;
  background: url('http://tic.upkao.com/Public/wxappImgs/video-bg.png') no-repeat;
  background-size: 100% 100%;
  position: relative;
}

.video-cover , .video-play {
    width: 578rpx;
    height: 316rpx;
    margin: 13rpx;
    position: absolute;
}

.video-play {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: center;
    background: rgba(0,0,0,0.5)
}

</style>
<template>
    <video id="video" class="key-video" style="{{fixStyles}}" custom-cache="{{false}}" show-progress="true" autoplay="true" page-gesture="true" src="{{currentVideoSrc}}" wx:if="{{isShowVideo}}" poster="{{currentVideoPoster}}"></video>

    <audio id="learnAudio" hidden="true"></audio>
    <audio id="r2mAudio" hidden="true"></audio>

    <image src="/images/main-bg.jpg" class="main-bg"></image>
    <view class="menu">
        <button @tap="tab(0)" class="menu-learn{{ currentNumber == 0 ? ' menu-learn-hover' : ''}}" title="学音标"></button>
        <button @tap="tab(1)" class="menu-read2me{{ currentNumber == 1 ? ' menu-read2me-hover' : ''}}" title="跟我读"></button>
        <button @tap="tab(2)" class="menu-interest{{ currentNumber == 2 ? ' menu-interest-hover' : ''}}" title="趣味音标课"></button>
    </view>

    <swiper @change="change()" current="{{currentIndex}}" duration="100" skip-hidden-item-layout="true">
        <learn :canUseNumber.sync="phoneticListCanUseNumber" :vipPhoneticList.sync="vipPhoneticList" :item.sync="learnPhoneticItem"></learn>
        <read2me :canUseNumber.sync="phoneticListCanUseNumber" :vipPhoneticList.sync="vipPhoneticList" :item.sync="learnPhoneticItem"></read2me>
        <interest :canUseNumber.sync="phonetiClassCanUseNumber" :phonetiClassInfo.sync="phonetiClassInfo" :item.sync="phonetiClassItem" :vipPhonetiClassList.sync="vipPhonetiClassList"></interest>
    </swiper>

     <view class="pay-ppw" wx:if="{{isShowPayView}}">
          <view class="pay-ppw-bg">
             <view class="pay-content">
                <view class="pay-item" wx:for="{{vipList}}"  wx:for-index="index" wx:for-item="item" wx:key="id">    
                   <view class="pay-info">
                        <image class="pay-num" src="{{item.icon}}"></image>
                        <view class="pay-desc">
                           <view class="pay-title" style="{{ (item.title.length > 7) ? 'font-size: 23rpx;' : ''}}">{{item.title}}</view>
                           <view class="pay-simple-desc">{{item.sub_title}}</view>
                        </view>
                        <view class="pay-price">
                            <view class="pay-new-price">¥{{item.real_price}}</view>
                            <view class="pay-old-price">原价¥{{item.price}}元</view>
                        </view>
                   </view>
                   <image @tap="selectVip({{index}})" class="pay-select" src="{{item.isVip ? 'http://tic.upkao.com/Public/wxappImgs/pay-select-disable.png' : item.selectImg}}"></image>
                </view>
                 
               
            </view>
            <view class="pay-confirm-wrap">
                <button class="pay-confirm" open-type="getUserInfo" bindgetuserinfo="pay()"></button>
           </view>
          </view>
          <button class="pay-close" @tap="closePayView()"></button>
    </view>

    <view class="intro" hidden="{{isShowIntroView}}" >
        <image src="/images/intro.png" />
       <button class="intro-close" @tap="closeIntroView()"></button>
    </view>

    <view class="intro" wx:if="{{isShowContactView}}">
      <view class="contact-ppw-bg">
          <image src="http://tic.upkao.com/Public/wxappImgs/contact_tel.png" style="width:600rpx; height:327rpx; margin-top:50rpx"></image>
          <view class="contact-input-bg">
             <input placeholder="请您输入手机号" type="number" @input="getInput()"/>
          </view>
          <button class="contact-confirm" @tap="updateUserInfo()"></button>

      </view>
       <button class="contact-close" @tap="closeContactView()"></button>
    </view> 

</template>

<script>
  import wepy from 'wepy'

  import Read2me from '../components/read2me'
  import Learn from '../components/learn'
  import Interest from '../components/interest'

  import util from '../common/util.js'
  import global from '../common/global.js'
  import api from '../common/config.js'
  import req from '../common/request.js'
  import to from 'await-to-js'


  export default class Index extends wepy.page {
    config = {
    }

    components = {
       learn: Learn,
       read2me: Read2me,
       interest: Interest
    }

    mixins = []

    data = {
        currentNumber: 0,
        currentIndex: 0,      //当前swiper index
        currentVideoSrc: '',  //当前视频路径
        currentVideoPoster: '', //当前视频封面
        currentAudioSrc: '', //当前音频路径
        currentPayInfo: {},  //当前选择的支付信息
        currentLearnVideoInfo: {},
        currentInterestVideoInfo: {},

        vipPhoneticList: [],
        learnPhoneticItem: {},

        vipPhonetiClassList: [],
        phonetiClassItem: {},
        phonetiClassInfo: {},
        
        vipList: [],

        isMoved: false,
        isShowVideo: false,
        isShowPayView: false,
        isShowContactView: false,

        isShowIntroView: false,

        phoneNumber: "",

        scrollState: {
            pageX: 0,
            pageY: 0,
            isLeft: false,
            isRight: false
        },

        phonetiClassCanUseNumber: 1,
        phoneticListCanUseNumber: 4,

        fixStyles: ""
    }

    computed = {
       
    }

    methods = {
        //swiper切换
        change(itemId, e){
            let current = e.detail.current
            if(this.currentNumber == current) return  
            this.switched()
            this.currentNumber = current
        },
        getInput(value, e){
            this.phoneNumber = e.detail.value
        },
        async updateUserInfo(){
            let [err, res] = await req.post(api.updateUserUrl, {
                 mobile: this.phoneNumber
            })

            if(res.data.code == 1){
                this.isShowContactView = false
                this.$apply()
                return
            }
            wepy.showModal({
                        title: '提示',
                        content: res.data.msg+ '， 请重试',
                        showCancel: false
              })
        },
        closeContactView(){
            this.isShowContactView = false
        },
        tab(itemId , e){
            itemId = parseInt(itemId)
            if(itemId == this.currentNumber) return
            this.switched()
            this.currentNumber = itemId
            this.currentIndex = itemId
        },
        //关闭支付窗口
        closePayView(e){
            this.closePayView()
        },

        closeIntroView(e){
            this.isShowIntroView = true
        },

        goToYinBiao(e){
            wepy.navigateToMiniProgram({
                appId: "wxa1c3a325881d2d59"
            }).then((res)=>{
                this.isShowYinBiaoView = false
                this.$apply()
            }) 
        },

        //选择会员购买
        selectVip(index, e){
            if(this.vipList[index].isVip){
                return
            }
            this.currentPayInfo = this.vipList[index]
            this.vipList.forEach((item, i)=>{
                if(index == i ){
                    if(!item.isVip){
                        item.selectImg = "http://tic.upkao.com/Public/wxappImgs/pay-select.png"
                    }
                    return
                }
                if(!item.isVip){
                    item.selectImg = "http://tic.upkao.com/Public/wxappImgs/pay-select-bg.png"
                }
            })
        },
        //确认购买
        async pay(e){ 
          let status = await util.authLogin()
          if(status == -2 || status == -1){
             return
          }

          // if(this.isPhoneticListVip() || this.isPhonetiClassVip()){
          //      this.setVip()
          //      return
          // } 

          let [err, pstatus]= await to(util.pay(this.currentPayInfo))
          if(pstatus){
              this.setVip()
              this.isShowContactView = true
              this.vipPhoneticList.forEach((item, k)=>{
                  if(item.id == this.currentPayInfo.id){
                      this.vipPhoneticList.splice(k, 1)
                  }
              })
          }
        }
    }

    setVip(){
      wepy.showLoading({
         title: '正在加载...'
      })
      this.closePayView()
      this.$apply()   

      this.$nextTick().then(()=>{
          wepy.hideLoading()
      })
    }

    closePayView(){
        this.isShowPayView = false
        if(this.currentNumber == 0){
               this.$invoke("learn", "back")
        }else if(this.currentNumber == 1){
               this.$invoke("read2me", "back")
        }else if(this.currentNumber == 2){
               this.$invoke("interest", "back")
        }
    }

    //切换或移动之后的操作
    switched(){
        if(this.currentNumber == 0 || this.currentNumber == 2){
             this.hideVideo()
        }
        if(this.currentNumber == 0 || this.currentNumber == 2){
            this.stop()
            this.$invoke('learn', 'playEnd')
        } else {
            this.$invoke('read2me', 'playOver')
        }
        wepy.hideLoading()
        this.$apply()
    }

    //vip检测

    //能看学音标模块
    isPhoneticListVip(){
       return api.superVip  || global.vips.includes(1) || global.vips.includes(2)  || global.vips.includes(3) || global.vips.includes(4) || global.vips.includes(12) || global.vips.includes(13)
    }
    
    isPhonetiClassVip(){
       return api.superVip  || global.vips.includes(4) || global.vips.includes(3)  || global.vips.includes(2) || global.vips.includes(12) || global.vips.includes(13)
    }
   

    //支付
    isShowPay(index){
       let status = false
       if( this.currentNumber == 0 && !this.isPhoneticListVip() && index >= this.phoneticListCanUseNumber){
           status = true
       }
       else if(this.currentNumber == 1 && !this.isPhoneticListVip() && index >= this.phoneticListCanUseNumber){
           status = true
       }
       else if(this.currentNumber == 2 && !this.isPhonetiClassVip() && index >= this.phonetiClassCanUseNumber){
           status = true
       }
       return status
    }


   

    showPayView(id){
        this.shareId = id
        this.isShowPayView = true
    }

    
    //视频
    playVideo(index){
        if(this.$parent.globalData.model && this.$parent.globalData.model.indexOf("iPhone X") > -1){
              this.fixStyles = "top:245rpx;"
        }
        let info 
        if(this.currentNumber == 0){
           info = this.vipPhoneticList[index]
        } else if(this.currentNumber == 2){
           info = this.vipPhonetiClassList[index]
        }
        if(info){
            this.currentVideoSrc = info.video.trim()
            this.currentVideoPoster = info.cover
        }
        this.isShowVideo = true
        this.$apply()
    }
   
    //隐藏视频
    hideVideo(){
       this.isShowVideo = false
    }

    //音频

    //播放音频
    play(src){
        if(this.currentNumber == 0){
          this.audioCtx = this.learnAudioCtx
        } else if(this.currentNumber == 1){
          this.audioCtx = this.r2mAudioCtx
        } 
        this.audioCtx.src = src
        this.audioCtx.play()
    }

    //停止播放
    stop(){
        this.learnAudioCtx.stop()
        this.r2mAudioCtx.stop()
    }

    //设置回调

    setAudior2mCallback(){
        //神坑 call设置多次 将会调用多次
        this.r2mAudioCtx.onEnded(()=>{
            this.$invoke('read2me', 'playEnd')
        })

        this.r2mAudioCtx.onPlay(()=>{
            this.$invoke('read2me', 'playing')
        })

        this.r2mAudioCtx.onError((res)=>{
            this.$invoke('read2me', 'playEnd')
        })
    }

    setAudioLearnCallback(){
        this.learnAudioCtx.onEnded(()=>{
           this.$invoke('learn', 'playEnd')
        })

        this.learnAudioCtx.onPlay(()=>{
           this.$invoke('learn', 'playing')
        })

        this.learnAudioCtx.onError((res)=>{
           this.learnAudioCtx.play()
        })
    }
    
    //接口  注 影响性能

    //获取拼音列表
    async getPhoneticList(){
       wepy.showLoading({
               title: '正在加载...'
       })
       let [phoneticListErr, phoneticList] = await req.get(api.phoneticList)
       
       if(phoneticList && phoneticList.data.data && phoneticList.data.data.list && phoneticList.data.data.list.length > 0){
          this.setPhoneticList(phoneticList.data.data.list)
          wepy.setStorage({
            key: api.phoneticList,
            data: this.vipPhoneticList
          })
          return
       }

       let [cacheErr, cacheRes] = await to(wepy.getStorage({
          key : api.phoneticList
       }))

       if(cacheRes && cacheRes.data && cacheRes.data.length > 0){
            this.setPhoneticList(cacheRes.data)
            return
       }

       wepy.hideLoading()
       self.getPhoneticList()
    }



     setPhoneticList(phoneticList){
          this.vipPhoneticList = phoneticList
          this.vipPhoneticList.forEach((item, k)=>{
               item.animation = ''
               item.sampleAnimation = ''
               item.playingImg = '/images/click2read.png'
               let name = item.name.substr(1, item.name.length - 2).replace(" ", "")
               item.example.forEach((example)=>{
                   example.word_phonetic = example.word_phonetic.replace(name, `<b style='color:#ff0000'>${name}</b>`)
               })
               if( this.isPhoneticListVip() || k < this.phoneticListCanUseNumber){
                   item.isShowLock = false
               } else {
                   item.isShowLock = true
               }
          })
          this.learnPhoneticItem = this.vipPhoneticList[0]
          this.$apply()
          this.$nextTick().then(() => {
              wepy.hideLoading()
          });
    }

   
    //获取趣味音标
    async getPhonetiClass(){
       let [phonetiClassErr, phonetiClass] = await req.get(api.phonetiClass)
        
       if(!phonetiClassErr && phonetiClass.data.data && phonetiClass.data.data.list && phonetiClass.data.data.list.length > 0){
          this.setPhonetiClass(phonetiClass.data.data)
          wepy.setStorage({
                 key: api.phonetiClass,
                 data: phonetiClass.data.data
          })
          return
       }

       wepy.getStorage({
          key : api.phonetiClass
       }).then((res)=>{
           if(res && res.data){
              this.setPhonetiClass(res.data)
           }
       })
  
    } 

    setPhonetiClass(data){
        this.phonetiClassInfo = data.info
        this.vipPhonetiClassList = data.list
        this.phonetiClassItem = this.vipPhonetiClassList[0]
        console.log(this.phonetiClassInfo)
        this.$apply()
    }
   
   //获取会员商品信息
    async getVipList(){
       let [vipListErr, vipList] =  await req.get(api.vipList)
       
       if(!vipListErr && vipList.data.data && vipList.data.data.vip_list){
            this.setVipList(vipList.data.data.vip_list)
            wepy.setStorage({
                 key: api.vipList,
                 data: this.vipList
             })
            return
       }

       wepy.getStorage({
          key : api.vipList
       }).then((res)=>{
         if(res && res.data){
           this.setVipList(res.data)
         }
       })
    }

    initVipList(isvip = false){
      this.vipList.forEach((item,k)=>{  
                global.vips.forEach(vipId=>{
                     if(vipId == item.id){     
                          item.isVip = true
                          this.vipList.splice(k, 1)
                      }
                })
                if(item.isVip){
                    item.selectImg = "http://tic.upkao.com/Public/wxappImgs/pay-select-disable.png"
                } else {
                    item.selectImg = "http://tic.upkao.com/Public/wxappImgs/pay-select-bg.png"
                }
       })
    }

    setVipList(vipList){
            this.vipList = vipList
            console.log(vipList)
            this.initVipList()
            this.vipList[0]['selectImg'] = "http://tic.upkao.com/Public/wxappImgs/pay-select.png"
            this.currentPayInfo = this.vipList[0]
    }

    async onLoad(params, data) {
       let status = await util.login2()

       this.getPhoneticList()

       this.getPhonetiClass()

       this.getVipList()

       
      let [err, res] = await to(wepy.getStorage({
            key : 'isShowIntro'
      }));
      
      if(err){
          this.isShowIntroView = false
          this.$apply()
      } else {
          let result = false
          if(res){
              result = res.data
          }
          if(!result){
                  wepy.setStorage({
                      key: 'isShowIntro',
                      data: true
                  })
          }
          this.isShowIntroView = result
          this.$apply()
        }
    }

    reLoadData(){
       if(!this.vipPhoneticList || this.vipPhoneticList.length == 0){
           this.getPhoneticList()
       }

       if(!this.vipPhonetiClassList || this.vipPhonetiClassList.length == 0){
           this.getPhonetiClass()
       }

       if(!this.vipList || this.vipList.length == 0){
           this.getVipList()
       }
    }

    onShow(){
       if(this.onShowed){
          this.reLoadData()
          return
       }
       this.onShowed = true
    }

    onReady(res) {
        this.learnAudioCtx = wx.createInnerAudioContext('learnAudio')
        this.r2mAudioCtx = wx.createInnerAudioContext('r2mAudio')
        this.setAudior2mCallback()
        this.setAudioLearnCallback()
    }

    onShareAppMessage(res){
        let self = this
        return {
              title: '英语音标点读小程序上线了，每天十分钟，十天就会读音标',
              path: '/pages/index',
              success: function(res) {
                  wepy.showToast({
                      title: '分享成功'
                  })
                  if(self.shareId != undefined){
                      self.closePayView()
                      self.$apply()
                  }
              },
              fail: function(res) {
                  let msg = '分享失败'
                  wepy.showToast({
                      title: msg ? msg : '分享失败',
                      icon: 'none'
                  })
              }
        }
    }
  }
</script>
